// Prisma Schema for Signage Digital System
// Stack: PostgreSQL 15 + Prisma ORM
// Project: Sistema de Señalización Digital para Hoteles

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// ENUMS
// ==============================================

enum UserRole {
  SUPER_ADMIN
  HOTEL_ADMIN
  AREA_MANAGER
}

enum DisplayStatus {
  ONLINE
  OFFLINE
  ERROR
}

enum ContentType {
  VIDEO
  IMAGE
  HTML
}

enum ContentStatus {
  PENDING
  PROCESSING
  READY
  ERROR
}

enum ContentSource {
  FILE
  YOUTUBE
  VIMEO
  URL
}

enum AlertType {
  INFO
  WARNING
  EMERGENCY
}

enum SyncState {
  STOPPED
  PLAYING
  PAUSED
}

// ==============================================
// MODELS
// ==============================================

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String
  role     UserRole @default(AREA_MANAGER)

  // 2FA Authentication
  twoFactorSecret  String?
  twoFactorEnabled Boolean @default(false)

  // Hotel relationship (optional, only for HOTEL_ADMIN and AREA_MANAGER)
  hotelId String?
  hotel   Hotel?  @relation(fields: [hotelId], references: [id], onDelete: SetNull)

  // Area relationship (optional, only for AREA_MANAGER)
  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  createdSchedules Schedule[]
  createdAlerts    Alert[]
  activityLogs     UserActivityLog[]

  // Audit relations
  auditLogs        AuditLog[]
  sessions         SessionLog[]

  @@index([email])
  @@index([hotelId])
  @@index([areaId])
  @@index([role])
  @@map("users")
}

model Hotel {
  id      String @id @default(cuid())
  name    String @unique  // Hotel names must be globally unique
  address String

  // Relationships
  users      User[]
  areas      Area[]
  displays   Display[]
  contents   Content[]
  schedules  Schedule[]
  alerts     Alert[]
  syncGroups SyncGroup[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("hotels")
}

model Area {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Hotel relationship (obligatorio)
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Relationships
  displays  Display[]
  users     User[]
  schedules Schedule[]
  alerts    Alert[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hotelId, name])  // No duplicate area names within same hotel
  @@index([hotelId])
  @@index([name])
  @@map("areas")
}

model Display {
  id       String        @id @default(cuid())
  name     String
  location String
  status   DisplayStatus @default(OFFLINE)

  // Display configuration
  orientation String @default("horizontal")  // 'horizontal' | 'vertical'
  resolution  String @default("1920x1080")   // '1920x1080' | '3840x2160' | custom

  // Hotel relationship
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Area relationship
  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  // Device information
  lastSeen   DateTime?
  deviceInfo Json?

  // Pairing information
  pairingCode String?   @unique
  pairedAt    DateTime?

  // Error tracking
  lastError     String?   // Error message
  lastErrorCode String?   // Error code (CONNECTION_LOST, CONTENT_FAILED, etc.)
  lastErrorAt   DateTime? // When error occurred
  errorCount    Int       @default(0) // Error counter

  // Fallback content when no other content is available
  fallbackContentId String?
  fallbackContent   Content? @relation("DisplayFallback", fields: [fallbackContentId], references: [id], onDelete: SetNull)

  // Relationships
  displayContents DisplayContent[]
  schedules       Schedule[]
  alerts          Alert[]
  syncGroups      SyncGroupDisplay[]
  conductorOf     SyncGroup[]        @relation("SyncConductor")

  // Audit logs
  playbackLogs         PlaybackLog[]
  contentSourceChanges ContentSourceChange[]
  stateHistory         DisplayStateHistory[]
  configHistory        DisplayConfigHistory[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hotelId, name])  // No duplicate display names within same hotel
  @@index([hotelId])
  @@index([status])
  @@index([areaId])
  @@index([pairingCode])
  @@map("displays")
}

model Content {
  id     String        @id @default(cuid())
  name   String
  type   ContentType
  status ContentStatus @default(PENDING)
  source ContentSource @default(FILE)

  // File URLs or external URL
  originalUrl  String
  hlsUrl       String?
  thumbnailUrl String?

  // Media metadata
  duration    Int?       // Duration in seconds (for video)
  resolution  String?    // e.g., '1920x1080'
  fileSize    BigInt?
  width       Int?       // Original width in pixels
  height      Int?       // Original height in pixels
  aspectRatio String?    // '16:9', '9:16', '4:3', '1:1', etc.
  orientation String?    // 'horizontal' | 'vertical' | 'square'

  // Hotel relationship
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Relationships
  displayContents   DisplayContent[]
  schedules         Schedule[]
  alerts            Alert[]
  syncGroups        SyncGroup[]
  syncGroupContents SyncGroupContent[]
  displayFallbacks  Display[]          @relation("DisplayFallback")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hotelId, name])  // No duplicate content names within same hotel
  @@index([hotelId])
  @@index([type])
  @@index([status])
  @@map("contents")
}

model DisplayContent {
  id String @id @default(cuid())

  displayId String
  display   Display @relation(fields: [displayId], references: [id], onDelete: Cascade)

  contentId String
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  order     Int
  startTime DateTime?
  endTime   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([displayId, contentId])
  @@index([displayId])
  @@index([contentId])
  @@index([startTime, endTime])
  @@map("display_contents")
}

// ==============================================
// SCHEDULING MODEL
// ==============================================

model Schedule {
  id   String @id @default(cuid())
  name String

  // Contenido a mostrar
  contentId String
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Destino: Display específico o área
  displayId String?
  display   Display? @relation(fields: [displayId], references: [id], onDelete: Cascade)

  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: Cascade)

  // Temporalidad
  startDate  DateTime
  endDate    DateTime?
  startTime  String
  endTime    String
  recurrence String?

  // Prioridad
  priority Int     @default(0)
  isActive Boolean @default(true)

  // RBAC
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Audit
  createdBy String
  creator   User   @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@index([displayId])
  @@index([areaId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("schedules")
}

// ==============================================
// ALERTS MODEL
// ==============================================

model Alert {
  id      String  @id @default(cuid())
  name    String
  message String?

  // Contenido a mostrar
  contentId String
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Alcance (cascada: hotel > área > display)
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: Cascade)

  displayId String?
  display   Display? @relation(fields: [displayId], references: [id], onDelete: Cascade)

  // Tipo y prioridad
  type     AlertType @default(INFO)
  priority Int       @default(100)

  // Temporalidad
  startAt DateTime @default(now())
  endAt   DateTime?

  // Estado
  isActive Boolean @default(true)

  // Audit
  createdBy String
  creator   User   @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId, isActive])
  @@index([areaId, isActive])
  @@index([displayId, isActive])
  @@index([startAt, endAt])
  @@map("alerts")
}

// ==============================================
// SYNC GROUP MODELS
// ==============================================

model SyncGroup {
  id   String @id @default(cuid())
  name String

  // Contenido único o playlist
  contentId String?
  content   Content? @relation(fields: [contentId], references: [id], onDelete: SetNull)

  playlistItems SyncGroupContent[]

  // Estado de reproducción
  state       SyncState @default(STOPPED)
  position    Float     @default(0)
  currentItem Int       @default(0)

  // Schedule del sync group
  scheduleEnabled    Boolean   @default(false)
  scheduleStart      DateTime?
  scheduleEnd        DateTime?
  scheduleStartTime  String?
  scheduleEndTime    String?
  scheduleRecurrence String?

  // Displays miembros
  displays SyncGroupDisplay[]

  // Conductor actual
  conductorId String?
  conductor   Display? @relation("SyncConductor", fields: [conductorId], references: [id], onDelete: SetNull)

  // RBAC
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@index([state])
  @@map("sync_groups")
}

model SyncGroupDisplay {
  id String @id @default(cuid())

  syncGroupId String
  syncGroup   SyncGroup @relation(fields: [syncGroupId], references: [id], onDelete: Cascade)

  displayId String
  display   Display @relation(fields: [displayId], references: [id], onDelete: Cascade)

  // Video wall region (optional)
  region String?

  joinedAt DateTime @default(now())

  @@unique([syncGroupId, displayId])
  @@index([syncGroupId])
  @@index([displayId])
  @@map("sync_group_displays")
}

model SyncGroupContent {
  id String @id @default(cuid())

  syncGroupId String
  syncGroup   SyncGroup @relation(fields: [syncGroupId], references: [id], onDelete: Cascade)

  contentId String
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  order    Int
  duration Int?

  @@unique([syncGroupId, order])
  @@index([syncGroupId])
  @@map("sync_group_contents")
}

// ==============================================
// AUDIT MODELS
// ==============================================

model PlaybackLog {
  id String @id @default(cuid())

  displayId String
  display   Display @relation(fields: [displayId], references: [id], onDelete: Cascade)

  // What was shown
  sourceType String
  sourceId   String?
  contentId  String

  // Timing
  startedAt DateTime
  endedAt   DateTime?
  duration  Int?

  // Why it changed
  endReason String?

  // Metadata
  hotelId String

  @@index([displayId, startedAt])
  @@index([hotelId, startedAt])
  @@index([contentId])
  @@map("playback_logs")
}

model ContentSourceChange {
  id String @id @default(cuid())

  displayId String
  display   Display @relation(fields: [displayId], references: [id], onDelete: Cascade)

  fromType String?
  fromId   String?
  toType   String
  toId     String?

  reason String

  timestamp DateTime @default(now())

  @@index([displayId, timestamp])
  @@map("content_source_changes")
}

// ==============================================
// USER ACTIVITY LOG
// ==============================================

model UserActivityLog {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Activity type
  action     String   // 'LOGIN', 'LOGOUT', 'CREATE_CONTENT', etc.
  resource   String?  // 'content', 'display', 'schedule', etc.
  resourceId String?

  // Metadata
  details   Json?
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action])
  @@index([createdAt])
  @@map("user_activity_logs")
}

// ==============================================
// DISPLAY STATE HISTORY
// Tracks every status change of displays
// ==============================================

model DisplayStateHistory {
  id String @id @default(cuid())

  displayId String
  display   Display @relation(fields: [displayId], references: [id], onDelete: Cascade)

  // State change
  fromStatus  String?
  toStatus    String
  
  // Error details
  errorCode    String?
  errorMessage String?

  // What triggered the change
  trigger     String
  triggeredBy String?

  // Metadata
  ipAddress  String?
  hotelId    String
  
  createdAt DateTime @default(now())

  @@index([displayId, createdAt])
  @@index([hotelId, createdAt])
  @@index([toStatus])
  @@map("display_state_history")
}

// ==============================================
// AUDIT LOG
// General audit trail for compliance
// ==============================================

model AuditLog {
  id String @id @default(cuid())

  // Actor
  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  actorType String

  // Action
  action      String
  category    String
  severity    String
  
  // Target
  resource    String?
  resourceId  String?
  resourceName String?

  // Details
  description String
  oldData     Json?
  newData     Json?
  metadata    Json?

  // Request info
  ipAddress   String?
  userAgent   String?

  // Scope
  hotelId     String?
  areaId      String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([hotelId, createdAt])
  @@index([category, createdAt])
  @@index([action])
  @@index([severity])
  @@map("audit_logs")
}

// ==============================================
// SESSION LOG
// Track user sessions
// ==============================================

model SessionLog {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session info
  sessionToken String    @unique
  status       String
  
  // Device/Location
  ipAddress    String?
  userAgent    String?
  deviceType   String?
  browser      String?
  os           String?

  // Timing
  startedAt   DateTime  @default(now())
  lastActiveAt DateTime @default(now())
  expiresAt   DateTime
  endedAt     DateTime?
  
  // End reason
  endReason   String?

  // Scope
  hotelId     String?

  @@index([userId, status])
  @@index([hotelId, startedAt])
  @@index([status])
  @@map("session_logs")
}

// ==============================================
// DISPLAY CONFIG HISTORY
// Track configuration changes for displays
// ==============================================

model DisplayConfigHistory {
  id String @id @default(cuid())

  displayId String
  display   Display @relation(fields: [displayId], references: [id], onDelete: Cascade)

  // What changed
  field     String  // 'name', 'location', 'fallbackContentId', 'areaId', etc.
  oldValue  String?
  newValue  String?

  // Who changed it
  changedBy     String?
  changedByName String?

  hotelId   String
  createdAt DateTime @default(now())

  @@index([displayId, createdAt])
  @@index([hotelId, createdAt])
  @@map("display_config_history")
}

// ==============================================
// CONTENT ACCESS LOG
// Track who accessed/modified content
// ==============================================

model ContentAccessLog {
  id String @id @default(cuid())

  contentId String

  // Actor
  userId    String?
  actorType String  // 'USER', 'SYSTEM', 'PLAYER'

  // Action
  action    String  // 'VIEW', 'DOWNLOAD', 'MODIFY', 'DELETE', 'STREAM'

  // Details
  details   Json?
  ipAddress String?

  hotelId   String
  createdAt DateTime @default(now())

  @@index([contentId, createdAt])
  @@index([userId, createdAt])
  @@index([hotelId, createdAt])
  @@map("content_access_logs")
}
