// Prisma Schema for Signage Digital System
// Stack: PostgreSQL 15 + Prisma ORM
// Project: Sistema de Señalización Digital para Hoteles

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================
// ENUMS
// ==============================================

enum UserRole {
  SUPER_ADMIN
  HOTEL_ADMIN
  AREA_MANAGER
}

enum DisplayStatus {
  ONLINE
  OFFLINE
  ERROR
}

enum ContentType {
  VIDEO
  IMAGE
  HTML
}

enum ContentStatus {
  PENDING
  PROCESSING
  READY
  ERROR
}

// ==============================================
// MODELS
// ==============================================

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String
  role     UserRole @default(AREA_MANAGER)

  // 2FA Authentication
  twoFactorSecret  String?
  twoFactorEnabled Boolean @default(false)

  // Hotel relationship (optional, only for HOTEL_ADMIN and AREA_MANAGER)
  hotelId String?
  hotel   Hotel?  @relation(fields: [hotelId], references: [id], onDelete: SetNull)

  // Area relationship (optional, only for AREA_MANAGER)
  // CAMBIO: Agregado para vincular AREA_MANAGER a un área específica
  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Schedules created by this user
  createdSchedules Schedule[]

  @@index([email])
  @@index([hotelId])
  @@index([areaId])
  @@index([role])
  @@map("users")
}

model Hotel {
  id      String @id @default(cuid())
  name    String
  address String

  // Relationships
  users     User[]
  areas     Area[]    // CAMBIO: Agregado para gestionar áreas del hotel
  displays  Display[]
  contents  Content[]
  schedules Schedule[] // Schedules de este hotel

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@map("hotels")
}

// NUEVO MODELO: Area para organización jerárquica
model Area {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Hotel relationship (obligatorio)
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Relationships
  displays  Display[] // Displays que pertenecen a esta área
  users     User[]    // Area Managers asignados a esta área
  schedules Schedule[] // Schedules aplicados a esta área

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@index([name])
  @@map("areas")
}

model Display {
  id       String        @id @default(cuid())
  name     String
  location String
  status   DisplayStatus @default(OFFLINE)

  // Hotel relationship
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Area relationship (optional for grouping displays)
  // CAMBIO: Convertido de String? a relación FK real
  areaId String?
  area   Area?   @relation(fields: [areaId], references: [id], onDelete: SetNull)

  // Device information
  lastSeen   DateTime?
  deviceInfo Json?

  // Pairing information
  pairingCode String?   @unique
  pairedAt    DateTime?

  // Relationships
  displayContents DisplayContent[]
  schedules       Schedule[] // Schedules directos del display

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@index([status])
  @@index([areaId])
  @@index([pairingCode])
  @@map("displays")
}

model Content {
  id     String        @id @default(cuid())
  name   String
  type   ContentType
  status ContentStatus @default(PENDING)

  // File URLs
  originalUrl  String  // Original uploaded file
  hlsUrl       String? // HLS m3u8 URL (for videos after transcoding)
  thumbnailUrl String? // Thumbnail/preview image

  // Metadata
  duration   Int?    // Duration in seconds (for videos)
  resolution String? // Video resolution (e.g., "1920x1080")
  fileSize   BigInt? // File size in bytes

  // Hotel relationship
  hotelId String
  hotel   Hotel  @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Relationships
  displayContents DisplayContent[]
  schedules       Schedule[] // Schedules que usan este contenido

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@index([type])
  @@index([status])
  @@map("contents")
}

model DisplayContent {
  id String @id @default(cuid())

  // Many-to-many relationship between Display and Content
  displayId String
  display   Display @relation(fields: [displayId], references: [id], onDelete: Cascade)

  contentId String
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Scheduling
  order     Int
  startTime DateTime?
  endTime   DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([displayId, contentId])
  @@index([displayId])
  @@index([contentId])
  @@index([startTime, endTime])
  @@map("display_contents")
}

// ==============================================
// SCHEDULING MODEL
// ==============================================

model Schedule {
  id   String @id @default(cuid())
  name String

  // Contenido a mostrar
  contentId String
  content   Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  // Destino: Display específico (opcional)
  displayId String?
  display   Display? @relation(fields: [displayId], references: [id], onDelete: Cascade)

  // O aplicar a todos los displays de un área (opcional)
  areaId String?
  area   Area? @relation(fields: [areaId], references: [id], onDelete: Cascade)

  // Temporalidad
  startDate DateTime // Fecha inicio
  endDate   DateTime? // Fecha fin (null = sin fecha fin)
  startTime String // "09:00" formato HH:mm
  endTime   String // "18:00" formato HH:mm

  // Recurrencia (RFC 5545 RRULE)
  recurrence String? // "FREQ=DAILY;BYDAY=MO,TU,WE,TH,FR" o null para único

  // Prioridad (mayor número = mayor prioridad)
  priority Int @default(0)

  // Estado
  isActive Boolean @default(true)

  // RBAC - Hotel owner
  hotelId String
  hotel   Hotel @relation(fields: [hotelId], references: [id], onDelete: Cascade)

  // Audit - Quien creó
  createdBy String
  creator   User @relation(fields: [createdBy], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hotelId])
  @@index([displayId])
  @@index([areaId])
  @@index([startDate, endDate])
  @@index([isActive])
  @@map("schedules")
}

